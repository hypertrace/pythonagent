[tox]
envlist = test_mysql_instrumentation
skipsdist = true

[testenv]
install_command = pip install {opts} {packages}
basepython=python3.8
sitepackages = True

[testenv:test_mysql_instrumentation]
deps =
    -rrequirements.txt

whitelist_externals =
    docker-compose
    chcon
    sleep
setenv =
  PYTHONPATH=../..
  ENABLE_INSTRUMENTATION=False
  HT_TRACES_EXPORTER=zipkin
  HT_REPORTING_ENDPOINT=http://localhost:9411/api/v2/spans
  
  passenv = *

commands =
    docker-compose stop
    docker-compose build
    docker-compose rm -v -f
    bash -ec 'if [ `uname` = '"'"'Linux'"'"' ] && [ "{env:GITHUB_ACTIONS}" != true ]; then chcon -h system_u:object_r:bin_t:s0 sql; chcon -Rt svirt_sandbox_file_t sql; fi'
    docker-compose up -d flask_app1
    sleep 15
    pytest -rPx test_gunicorn_1.py
    docker-compose stop flask_app1
    docker-compose up -d flask_app2
    pytest -rPx test_gunicorn_2.py
    docker-compose stop flask_app2
    docker-compose up -d flask_app3
    pytest -rPx test_gunicorn_3.py
    docker-compose stop
recreate = True
