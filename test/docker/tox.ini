[tox]
envlist = py37, py38, py39
skipsdist = true

[testenv]
install_command = pip install {opts} {packages}
sitepackages = True

deps =
    -rrequirements.txt

whitelist_externals =
    docker-compose
    chcon
    sleep
    pytest
    bash

setenv =
  PYTHONPATH=../../src
  HT_TRACES_EXPORTER=zipkin
  HT_REPORTING_ENDPOINT=http://localhost:9411/api/v2/spans
  HT_LOG_LEVEL=DEBUG

passenv = *

commands =
    docker-compose stop
    docker-compose build
    docker-compose rm -v -f
    docker-compose up -d flask_app
    docker-compose stop flask_app
    docker ps -aq
    docker stop $(docker ps -aq)
    docker rm $(docker ps -aq)
    docker rmi $(docker images -q)
    docker image prune -a -f
    docker volume prune -f

recreate = True
