[tox]
skipsdist = true
envlist = py3{7,8,9}

[testenv]
sitepackages = True
install_command = pip install {opts} {packages}

deps =
    -rrequirements.txt

whitelist_externals =
    pytest
    docker-compose
    sleep

setenv =
  PYTHONPATH=../../src
  ENABLE_INSTRUMENTATION=True
  HT_CONFIG_FILE=./agent-config.yaml
  HT_REPORTING_TRACE_REPORTER_TYPE=zipkin
  HT_REPORTING_ENDPOINT=http://localhost:9411/api/v2/spans
  HT_LOG_LEVEL={env:HT_LOG_LEVEL:}
  HT_ENABLE_CONSOLE_SPAN_EXPORTER=True

commands =
    docker-compose stop
    docker-compose build
    docker-compose rm -v -f
    docker-compose up -d flask_app_b
    sleep 10
    pytest -rPx test_aiohttp_1.py
    pytest -rPx test_aiohttp_2.py
    pytest -rPx test_aiohttp_3.py
#    docker-compose stop flask_app_b
#    docker-compose up -d flask_app_c
    pytest -rPx test_aiohttp_4.py
#    docker-compose stop

recreate = True
