[tox]
envlist = py37, py38, py39
skipsdist = true

[testenv]
install_command = pip install {opts} {packages}
sitepackages = True

deps =
    -rrequirements.txt

whitelist_externals =
    docker
    docker-compose
    chcon
    sleep
    pytest
    bash

setenv =
  PYTHONPATH=../../src
  HT_TRACES_EXPORTER=zipkin
  HT_REPORTING_ENDPOINT=http://localhost:9411/api/v2/spans
  HT_LOG_LEVEL=DEBUG
  HT_ENABLE_CONSOLE_SPAN_EXPORTER=True

passenv = *

commands =
    docker-compose stop mysqldb
    bash -ec "if [ `uname` = 'Linux' ] && [ "{env:GITHUB_ACTIONS:false}" != "true" ]; then chcon -h system_u:object_r:bin_t:s0 sql; chcon -Rt svirt_sandbox_file_t sql; fi"
    bash -ec "if [ `uname` = 'Linux' ] && [ "{env:GITHUB_ACTIONS:false}" != "true" ]; then chcon -h system_u:object_r:bin_t:s0 sql; chcon -Rt svirt_sandbox_file_t docker-healthcheck; fi"
    docker-compose up -d --remove-orphans --force-recreate -V mysqldb
    bash -ec "set -x; while [ `docker inspect -f '\{\{ .State.Health.Status \}\}' mysqldb` != 'healthy' ]; do echo 'Waiting for MySQL to be up'; sleep 2; done"
    pytest -rPx test_mysql_1.py # Basic INSERT Statement instrumentation test
    pytest -rPx test_mysql_2.py # Flask + Mysql instrumentation test
    pytest -rPx test_mysql_3.py # INSERT with SELECT
    pytest -rPx test_mysql_4.py # UPDATE
    pytest -rPx test_mysql_5.py # DELETE
    pytest -rPx test_mysql_6.py # PROCEDURE
    pytest -rPx test_mysql_7.py # Transaction with inserts
    docker-compose stop mysqldb
    docker-compose down --rmi all

recreate = True
