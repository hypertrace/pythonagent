[tox]
envlist = py38, py39
skipsdist = true

[testenv]
install_command = pip install {opts} {packages}
sitepackages = True

deps =
    -rrequirements.txt

whitelist_externals =
    docker-compose
    chcon
    sleep
    pytest
    bash

setenv =
  PYTHONPATH=../../src
  HT_REPORTING_TRACE_REPORTER_TYPE=zipkin
  HT_REPORTING_ENDPOINT=http://localhost:9411/api/v2/spans
  HT_LOG_LEVEL={env:HT_LOG_LEVEL:}
  HT_ENABLE_CONSOLE_SPAN_EXPORTER=True

passenv = *

commands =
    docker-compose stop
    docker-compose rm -v -f
    docker-compose pull db
    bash -ec 'if [ `uname` = '"'"'Linux'"'"' ] && [ "{env:GITHUB_ACTIONS:false}" != true ]; then chcon -h system_u:object_r:bin_t:s0 sql; chcon -Rt svirt_sandbox_file_t sql; fi'
    docker-compose up -d db
    sleep 20
    pytest -rPx test_postgresql_1.py
    pytest -rPx test_postgresql_2.py
    pytest -rPx test_postgresql_3.py
    pytest -rPx test_postgresql_4.py
    pytest -rPx test_postgresql_5.py
    pytest -rPx test_postgresql_6.py
    docker-compose stop db
    docker-compose down --rmi all

recreate = True
